/*! hapify-cli 2019-03-02 */

"use strict";var __awaiter=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(a,r){function o(t){try{l(n.next(t))}catch(t){r(t)}}function s(t){try{l(n.throw(t))}catch(t){r(t)}}function l(t){t.done?a(t.value):new i(function(e){e(t.value)}).then(o,s)}l((n=n.apply(t,e||[])).next())})},__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const Path=__importStar(require("path")),interface_1=require("../interface"),_1=require("./"),enum_1=require("../enum"),md5_1=__importDefault(require("md5")),Joi=__importStar(require("joi")),FieldType_1=require("./FieldType"),typedi_1=require("typedi"),service_1=require("../service");class Channel{constructor(t,e=null){this.path=t,this.templates=[],this.storageService=typedi_1.Container.get(service_1.ChannelFileStorageService),this.name=e||Path.basename(t),this.id=md5_1.default(this.path),this.templatesPath=Path.join(this.path,Channel.defaultFolder)}load(){return __awaiter(this,void 0,void 0,function*(){yield this.validate();const t=yield this.storageService.get([this.path,Channel.configFile]),e=Joi.validate(t,interface_1.ConfigSchema);if(e.error)throw interface_1.TransformValidationMessage(e.error),e.error;this.config=t,this.config.name&&(this.name=this.config.name),this.project=yield _1.Project.getInstance(this.config.project);for(let t=0;t<this.config.templates.length;t++){const e=new _1.Template(this,Object.assign(this.config.templates[t],{content:""}));yield e.load(),this.templates.push(e)}this.modelsCollection=yield _1.ModelsCollection.getInstance(this.config.project),this.validator=new _1.Validator(this,this.config.validatorPath),yield this.validator.load()})}save(){return __awaiter(this,void 0,void 0,function*(){for(const t of this.templates)yield t.save();yield this.validator.save(),this.config.templates=this.templates.map(t=>{const e=t.toObject();return delete e.content,e}),this.config.validatorPath=this.validator.path,yield this.storageService.set([this.path,Channel.configFile],this.config);const t=this.templates.map(t=>[this.templatesPath,t.contentPath]);t.push([this.path,this.config.validatorPath]),yield this.storageService.cleanup([this.path,Channel.defaultFolder],t)})}isEmpty(){const t=this.validator.isEmpty(),e=this.templates.every(t=>t.isEmpty());return t&&e}filter(){this.templates=this.templates.filter(t=>!t.isEmpty())}validate(){return __awaiter(this,void 0,void 0,function*(){if(!(yield this.storageService.exists([this.path,Channel.configFile])))throw new Error(`Channel config's path ${this.path}/${Channel.configFile} does not exists.`)})}static changeProject(t,e){return __awaiter(this,void 0,void 0,function*(){if(!Channel.configExists(t))throw new Error(`Cannot find config file in ${t}`);const i=typedi_1.Container.get(service_1.ChannelFileStorageService),n=yield i.get([t,Channel.configFile]);n.project=e,yield i.set([t,Channel.configFile],n)})}static configExists(t){return __awaiter(this,void 0,void 0,function*(){return yield typedi_1.Container.get(service_1.ChannelFileStorageService).exists([t,Channel.configFile])})}static create(t){return __awaiter(this,void 0,void 0,function*(){if(yield Channel.configExists(t))throw new Error("A channel already exists in this directory.");const e=new Channel(t);e.config={validatorPath:`${Channel.defaultFolder}/validator.js`,name:e.name,description:"A brand new channel",project:"projectId",defaultFields:[{name:"Id",type:FieldType_1.FieldType.String,subtype:null,reference:null,primary:!0,unique:!1,label:!1,nullable:!1,multiple:!1,important:!1,searchable:!1,sortable:!1,isPrivate:!1,internal:!0,restricted:!1,ownership:!1}],templates:[{path:"models/{model.hyphen}/hello.js",engine:enum_1.TemplateEngine.Hpf,input:enum_1.TemplateInput.One}]};const i=new _1.Template(e,Object.assign(e.config.templates[0],{content:"// Hello <<M A>>"}));return e.templates.push(i),e.validator=new _1.Validator(e,e.config.validatorPath),e.validator.content="// Models validation script\nreturn { errors: [], warnings: [] };",e})}fromObject(t){return this.templates=t.templates.map(t=>{const e=this.templates.find(e=>e.path===t.path);return e?e.fromObject(t):new _1.Template(this,t)}),this.validator.content=t.validator,this}toObject(){return{id:this.id,name:this.name,description:this.config.description||null,logo:this.config.logo||null,templates:this.templates.map(t=>t.toObject()),validator:this.validator.content}}}Channel.defaultFolder="hapify",Channel.configFile="hapify.json",exports.Channel=Channel;