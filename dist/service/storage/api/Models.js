/*! hapify-cli 2019-03-13 */

"use strict";var ModelsApiStorageService_1,__decorate=this&&this.__decorate||function(e,t,s,i){var r,o=arguments.length,a=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,s,i);else for(var c=e.length-1;c>=0;c--)(r=e[c])&&(a=(o<3?r(a):o>3?r(t,s,a):r(t,s))||a);return o>3&&a&&Object.defineProperty(t,s,a),a},__awaiter=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))(function(r,o){function a(e){try{n(i.next(e))}catch(e){o(e)}}function c(e){try{n(i.throw(e))}catch(e){o(e)}}function n(e){e.done?r(e.value):new s(function(t){t(e.value)}).then(a,c)}n((i=i.apply(e,t||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const typedi_1=require("typedi"),Base_1=require("./Base"),md5_1=__importDefault(require("md5")),class_1=require("../../../class");let ModelsApiStorageService=ModelsApiStorageService_1=class extends Base_1.BaseApiStorageService{constructor(){super(...arguments),this.hashes={}}forProject(e){return __awaiter(this,void 0,void 0,function*(){const t=yield this.list({project:e});return this.updateHashes(t),t})}set(e,t){return __awaiter(this,void 0,void 0,function*(){const s={},i=t.filter(e=>void 0===this.hashes[e.id]);for(const t of i){const i=yield this.create({project:e,name:t.name,fields:t.fields,accesses:t.accesses});s[t.id]=i.id,t.id=i.id}const r=Object.keys(this.hashes).filter(e=>!t.some(t=>t.id===e));for(const e of r)yield this.remove(e),s[e]=null;const o=t.filter(e=>"string"==typeof this.hashes[e.id]&&this.hashes[e.id]!==ModelsApiStorageService_1.hash(e));for(const e of o)yield this.update(e.id,{name:e.name,fields:e.fields,accesses:e.accesses});const a=e=>{let t=!1;for(const i of e.fields)i.type===class_1.FieldType.Entity&&void 0!==s[i.reference]&&(i.reference=s[i.reference],t=!0);return t};for(const e of t)a(e)&&(yield this.update(e.id,{fields:e.fields}));return this.updateHashes(t),t})}updateHashes(e){this.hashes={};for(const t of e)this.hashes[t.id]=ModelsApiStorageService_1.hash(t)}static hash(e){return md5_1.default(JSON.stringify(new class_1.Model(e).toObject()))}defaultSearchParams(){const e=super.defaultSearchParams();return e._limit=this.remoteConfig.modelsLimit,e}path(){return"model"}fromApi(e){return{id:e._id,name:e.name,fields:e.fields,accesses:e.accesses}}};ModelsApiStorageService=ModelsApiStorageService_1=__decorate([typedi_1.Service()],ModelsApiStorageService),exports.ModelsApiStorageService=ModelsApiStorageService;