/*! hapify-cli 2019-05-28 */

"use strict";var __decorate=this&&this.__decorate||function(e,t,i,r){var n,s=arguments.length,c=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(c=(s<3?n(c):s>3?n(t,i,c):n(t,i))||c);return s>3&&c&&Object.defineProperty(t,i,c),c},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__awaiter=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))(function(n,s){function c(e){try{a(r.next(e))}catch(e){s(e)}}function o(e){try{a(r.throw(e))}catch(e){s(e)}}function a(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(c,o)}a((r=r.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const typedi_1=require("typedi"),class_1=require("../class"),Channels_1=require("./Channels"),Info_1=require("./Info");let PresetsService=class{constructor(e,t){this.channelsService=e,this.infoService=t}collection(){return __awaiter(this,void 0,void 0,function*(){return yield class_1.PresetsCollection.getInstance()})}apply(e){return __awaiter(this,void 0,void 0,function*(){const t=[],i=[],r=yield(yield this.channelsService.modelsCollection()).list(),n={};for(const s of e){const e=r.find(e=>e.name===s.name);if(e){n[s.id]=e.id;const i=e.clone(!1),r=e.fields.some(e=>e.primary);let c=!1;for(const e of s.fields)r&&e.primary||i.fields.some(t=>t.name===e.name)||(i.fields.push(e),c=!0);c&&t.push(i)}else{const e=s.clone(!0);n[s.id]=e.id;const t=(yield this.infoService.fields()).map(e=>new class_1.Field(e)),r=t.find(e=>e.primary),c=e.fields.find(e=>e.primary);r&&c&&(r.ownership=c.ownership,e.fields=e.fields.filter(e=>!e.primary)),e.fields=t.concat(e.fields),i.push(e)}}const s=e=>{for(const t of e.fields)t.type===class_1.FieldType.Entity&&"string"==typeof n[t.reference]&&(t.reference=n[t.reference])};return t.forEach(s),i.forEach(s),{updated:t,created:i}})}};PresetsService=__decorate([typedi_1.Service(),__metadata("design:paramtypes",[Channels_1.ChannelsService,Info_1.InfoService])],PresetsService),exports.PresetsService=PresetsService;