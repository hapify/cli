/*! hapify-cli 2019-03-07 */

"use strict";var __decorate=this&&this.__decorate||function(e,t,r,i){var o,s=arguments.length,n=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(n=(s<3?o(n):s>3?o(t,r,n):o(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__awaiter=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))(function(o,s){function n(e){try{h(i.next(e))}catch(e){s(e)}}function a(e){try{h(i.throw(e))}catch(e){s(e)}}function h(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(n,a)}h((i=i.apply(e,t||[])).next())})},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(exports,"__esModule",{value:!0});const typedi_1=require("typedi"),Path=__importStar(require("path")),Options_1=require("./Options"),WebSocketServer_1=require("./WebSocketServer"),opn=require("opn"),DetectPort=require("detect-port"),hapi_1=require("hapi");let HttpServerService=class{constructor(e,t){this.optionsService=e,this.webSocketServerService=t,this.rootPath=Path.join(Path.dirname(require.main.filename),"..","html"),this._minPort=4800,this._maxPort=4820,this._port=this._minPort}get minPort(){return this._minPort}get maxPort(){return this._maxPort}get port(){return this._port}serve(){return __awaiter(this,void 0,void 0,function*(){this.started()||(this._port=this.optionsService.port()?this.optionsService.port():yield this.findAvailablePort(),this.server=new hapi_1.Server({port:this._port,routes:{cors:{credentials:!0},files:{relativeTo:this.rootPath}}}),yield this.server.register(require("inert")),this.server.route({method:"GET",path:"/{param*}",handler:{directory:{path:".",redirectToSlash:!0,index:!0}}}),this.server.ext("onPreResponse",(e,t)=>{const r=e.response;return r.isBoom&&404===r.output.statusCode?t.file("index.html").code(200):t.continue}),yield this.server.start(),this.serverStarted=!0,this.server.listener.on("close",()=>__awaiter(this,void 0,void 0,function*(){yield this.webSocketServerService.stop()})),yield this.webSocketServerService.serve(this.server.listener))})}stop(){return __awaiter(this,void 0,void 0,function*(){this.started()&&(this.serverStarted=!1,yield this.server.stop(),this.server=null)})}started(){return this.server&&this.serverStarted}open(){const e=this.url();e&&opn(e)}url(){return this.started()?`http://${this.optionsService.hostname()}:${this._port}`:null}findAvailablePort(e=0){return __awaiter(this,void 0,void 0,function*(){if(this._port>this._maxPort)throw new Error(`Reached maximum port number ${this._maxPort} to start HTTP server`);const t=this._port+e;return t!==(yield DetectPort(t))?this.findAvailablePort(e+1):t})}};HttpServerService=__decorate([typedi_1.Service(),__metadata("design:paramtypes",[Options_1.OptionsService,WebSocketServer_1.WebSocketServerService])],HttpServerService),exports.HttpServerService=HttpServerService;